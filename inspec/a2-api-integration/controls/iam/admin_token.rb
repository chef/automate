require_relative '../../../constants'

# encoding: utf-8
# copyright: 2017, Chef Software, Inc.
# license: All rights reserved
title 'iam introspection'

control 'iam-admin-token-1' do
  title 'IAM admin token'
  desc 'test IAM admin token'

  # only run this if we've been handed an admin token to use here
  only_if { ENV['INSPEC_UPGRADE_IAM_V2_3_ADMIN_TOKEN'] }

  describe 'IAM v2 admin token' do
    it 'GET iam/v2/policies returns 200 for admin token generated by "iam token create --admin"' do
      token = ENV['INSPEC_UPGRADE_IAM_V2_3_ADMIN_TOKEN']

      expect(
        automate_client_api_request(
          '/apis/iam/v2/policies',
          token,
          http_method: 'GET',
        ).http_status
      ).to eq(200)
    end
  end
end
