# NOTE(ssd) 2019-02-06: Please explicitly document why a given job is
# here and not in the public verify pipeline. The more jobs we have in
# this pipeline, the harder it is for external contributors.

expeditor:
  defaults:
    executor:
      docker:
        image_sha256: 50053cdc1798f75662f9da9ad87849d90ef03e8188fa6d00adfae7ee1350354c
        workdir: /go/src/github.com/chef/automate

steps:
  # Building hugo currently depends on a github token
  #     https://github.com/chef/chef-hugo-theme
  # which is currently private.
  - label: lint hugo site
    command:
      - .expeditor/buildkite/hugo_lint.sh
      - cd components/automate-chef-io && make lint
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1
    expeditor:
      accounts:
        - github
      executor:
        docker:

  # license scout requires github account access because we currently
  # rely on at least 2 private repositories.
  - label: license scout
    command:
      # here we reuse the license_scout.sh script used by expeditor to publish the manifest
      - .expeditor/license_scout.sh
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      secrets:
        GITHUB_TOKEN:
          account: github/chef
          field: token
      executor:
        docker:

  # The build depends on GitHub access to build
  # automate-chef-io. Further we need to build in order to run the
  # integration tests.
  - label: build
    command:
      - scripts/verify_build.sh
    timeout_in_minutes: 45
    env:
      ALLOW_LOCAL_PACKAGES: true
      HAB_STUDIO_SUP: false
      HAB_NONINTERACTIVE: true
    expeditor:
      secrets:
        HAB_STUDIO_SECRET_GITHUB_TOKEN:
          account: github/chef
          field: token
      executor:
        linux:
          privileged: true


  - label: "[unit] license-control-service"
    command:
      - scripts/install_golang.sh
      - scripts/setup_buildkite_pg.sh lcs_test
      - echo "\$A2_LICENSE" > dev/license.jwt
      - cd components/license-control-service
      - make lint test
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        docker:

  - label: "[unit] trial-license-service"
    command:
      - scripts/install_golang.sh
      - echo "\$A2_LICENSE" > dev/license.jwt
      - cd components/trial-license-service
      - make static unit
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        docker:

  # Wait for the build to complete before starting anything below this
  # directive. All tests below this wait either require build assets
  # or take a long time.
  - wait

  - label: "automate-load-balancer"
    command:
      - . scripts/verify_setup.sh
      - |
        hab studio run "source scripts/verify_studio_init.sh &&
          start_deployment_service &&
          chef-automate dev deploy-some chef/automate-load-balancer --with-deps &&
          automate_load_balancer_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "applications-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_applications_service_deps && applications_integration"
    timeout_in_minutes: 20
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  # The nodemanager tests require access to AWS and Azure accounts as
  # they test against the actual API endpoints of those services.
  - label: "nodemanager-integration-tests"
    command:
      - . scripts/verify_setup.sh
      - |
        hab studio run "source scripts/verify_studio_init.sh &&
          start_deployment_service &&
          chef-automate dev deploy-some chef/compliance-service --with-deps &&
          nodemanager_scans_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      secrets:
        HAB_STUDIO_SECRET_AZURE_CLIENT_ID:
          account: azure/inspec
          field: client_id
        HAB_STUDIO_SECRET_AZURE_CLIENT_SECRET:
          account: azure/inspec
          field: client_secret
        HAB_STUDIO_SECRET_AZURE_TENANT_ID:
          account: azure/inspec
          field: tenant_id
        HAB_STUDIO_SECRET_AWS_ACCESS_KEY_ID:
          account: aws/chef-cd
          field: access_key_id
        HAB_STUDIO_SECRET_AWS_SECRET_ACCESS_KEY:
          account: aws/chef-cd
          field: secret_access_key
        HAB_STUDIO_SECRET_AWS_SESSION_TOKEN:
          account: aws/chef-cd
          field: session_token
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  # The license_usage_nodes_test appears to require AWS access. We
  # might consider splitting this into two different tests.
  - label: "gateway-integration-tests"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_all_services && go_test ./components/automate-gateway/integration/..."
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      accounts:
        - aws/chef-cd
      secrets:
        HAB_STUDIO_SECRET_AWS_ACCESS_KEY_ID:
          account: aws/chef-cd
          field: access_key_id
        HAB_STUDIO_SECRET_AWS_SECRET_ACCESS_KEY:
          account: aws/chef-cd
          field: secret_access_key
        HAB_STUDIO_SECRET_AWS_SESSION_TOKEN:
          account: aws/chef-cd
          field: session_token
        HAB_STUDIO_SECRET_AUTOMATE_ACCEPTANCE_TARGET_HOST:
          path: secret/a2/testing/target_host
          field: data
        HAB_STUDIO_SECRET_AUTOMATE_ACCEPTANCE_TARGET_HOST2:
          path: secret/a2/testing/target_host2
          field: data
        HAB_STUDIO_SECRET_AUTOMATE_ACCEPTANCE_TARGET_USER:
          path: secret/a2/testing/target_user
          field: data
        HAB_STUDIO_SECRET_AUTOMATE_ACCEPTANCE_TARGET_KEY:
          path: secret/a2/testing/target_key
          field: data
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "automate-gateway-iam-v1"
    command:
      - . scripts/verify_setup.sh
      - |
        hab studio run "source scripts/verify_studio_init.sh &&
          start_deployment_service &&
          chef-automate dev deployinate &&
          gateway_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "automate-gateway-iam-v2"
    command:
      - . scripts/verify_setup.sh
      - |
        hab studio run "source scripts/verify_studio_init.sh &&
          start_deployment_service &&
          chef-automate dev deployinate &&
          chef-automate iam upgrade-to-v2 --skip-policy-migration &&
          gateway_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "secrets-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deploy-some chef/secrets-service --with-deps && secrets_integration"
    timeout_in_minutes: 10
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "event-feed-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh &&
          start_deployment_service &&
          chef-automate dev deploy-some chef/event-feed-service --with-deps &&
          event_feed_integration"
    timeout_in_minutes: 10
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "es-sidecar-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deploy-some chef/es-sidecar-service --with-deps && es_sidecar_service_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "ingest-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deploy-some chef/ingest-service --with-deps && ingest_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true
            - REST_SERVICE=https://localhost:10122

  - label: "compliance-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deploy-some chef/compliance-service --with-deps && compliance_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "config-mgmt-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deploy-some chef/automate-elasticsearch --with-deps && config_mgmt_integration"
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "event-service"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deployinate && event_integration"
    timeout_in_minutes: 10
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "event-gateway"
    command:
      - . scripts/verify_setup.sh
      - hab studio run "source scripts/verify_studio_init.sh && start_deployment_service && chef-automate dev deployinate && event_gateway_integration"
    timeout_in_minutes: 15
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  - label: "pg-sidecar-service"
    command:
      - . scripts/verify_setup.sh
      - |
        hab studio run "source scripts/verify_studio_init.sh &&
        start_deployment_service &&
        chef-automate dev deploy-some chef/pg-sidecar-service --with-deps &&
        pg_sidecar_integration"
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - HAB_STUDIO_SUP=false
            - HAB_NONINTERACTIVE=true

  #
  # The following tests all use the integration test framework for
  # end-to-end testing. These tests all test full deployments of
  # Automate in different configurations.
  #
  - label: ":cypress: (flaky included) IAMv1"
    command:
      - FLAKY=yes IAM=v1 integration/run_test integration/tests/cypress_e2e.sh
    timeout_in_minutes: 20
    soft_fail: true
    expeditor:
      secrets: &cypress_secrets
        A2_LICENSE:
          path: secret/a2/license
          field: license
        CYPRESS_AUTOMATE_ACCEPTANCE_TARGET_HOST:
          path: secret/a2/testing/target_host
          field: data
        CYPRESS_AUTOMATE_ACCEPTANCE_TARGET_USER:
          path: secret/a2/testing/target_user
          field: data
        CYPRESS_AUTOMATE_ACCEPTANCE_TARGET_KEY:
          path: secret/a2/testing/target_key
          field: data
      executor:
        linux:
          privileged: true

  - label: ":cypress: (flaky included) IAMv2"
    command:
      - FLAKY=yes IAM=v2.1 integration/run_test integration/tests/cypress_e2e.sh
    timeout_in_minutes: 20
    soft_fail: true
    expeditor:
      secrets: *cypress_secrets
      executor:
        linux:
          privileged: true

  - label: ":cypress: IAMv1"
    command:
      - FLAKY=no IAM=v1 integration/run_test integration/tests/cypress_e2e.sh
    timeout_in_minutes: 20
    expeditor:
      secrets: &cypress_secrets
        A2_LICENSE:
          path: secret/a2/license
          field: license
        CYPRESS_AUTOMATE_ACCEPTANCE_TARGET_HOST:
          path: secret/a2/testing/target_host
          field: data
        CYPRESS_AUTOMATE_ACCEPTANCE_TARGET_USER:
          path: secret/a2/testing/target_user
          field: data
        CYPRESS_AUTOMATE_ACCEPTANCE_TARGET_KEY:
          path: secret/a2/testing/target_key
          field: data
      executor:
        linux:
          privileged: true

  - label: ":cypress: IAMv2"
    command:
      - FLAKY=no IAM=v2.1 integration/run_test integration/tests/cypress_e2e.sh
    timeout_in_minutes: 30
    expeditor:
      secrets: *cypress_secrets
      executor:
        linux:
          privileged: true

  - label: "iam v2 (migrated w/ v1 policies)"
    command:
      - integration/run_test integration/tests/iam_v2_with_v1_policies.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "iam v2"
    command:
      - integration/run_test integration/tests/iam_v2_no_legacy_policies.sh
    timeout_in_minutes: 20
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        linux:
          privileged: true

  - label: "iam v2 (v2 only, diagnostics)"
    command:
      - integration/run_test integration/tests/iam_v2_upgrade_diagnostics.sh
    timeout_in_minutes: 20
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        linux:
          privileged: true

  - label: "a1migration"
    command:
      - integration/run_test integration/tests/a1migration.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "airgap a1migration"
    command:
      - integration/run_test integration/tests/airgap_a1migration.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "product"
    command:
      - integration/run_test integration/tests/product.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "product deployment stress mode"
    command:
      - integration/run_test integration/tests/product_deployment_stress.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "product airgap"
    command:
      - integration/run_test integration/tests/airgap_product.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "product dev"
    command:
      - integration/run_test integration/tests/product_dev.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "airgap upgrade"
    command:
      - integration/run_test integration/tests/airgap_upgrade.sh
    timeout_in_minutes: 30
    expeditor:
      executor:
        linux:
          privileged: true
  - label: "airgap ow upgrade"
    command:
      - integration/run_test integration/tests/airgap_ow_upgrade.sh
    timeout_in_minutes: 30
    expeditor:
      executor:
        linux:
          privileged: true
  - label: "airgap backup"
    command:
      - integration/run_test integration/tests/airgap_backup.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "chef server"
    command:
      - integration/run_test integration/tests/chef_server.sh
    timeout_in_minutes: 30 # longer timeout for chef-server
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "chef server only"
    command:
      - integration/run_test integration/tests/chef_server_only.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "ha chef server"
    command:
      - integration/run_test integration/tests/ha_chef_server.sh
    timeout_in_minutes: 35
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "workflow"
    command:
      - integration/run_test integration/tests/workflow.sh
    timeout_in_minutes: 30 # longer timeout for workflow
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "backup to s3"
    command:
      - integration/run_test integration/tests/backup_s3.sh
    timeout_in_minutes: 30
    expeditor:
      accounts:
        - aws/chef-cd
      executor:
        linux:
          single-use: true
          privileged: true
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
        AWS_ACCESS_KEY_ID:
          account: aws/chef-cd
          field: access_key_id
        AWS_SECRET_ACCESS_KEY:
          account: aws/chef-cd
          field: secret_access_key
        AWS_SESSION_TOKEN:
          account: aws/chef-cd
          field: session_token
  - label: "ontop backup "
    command:
      - integration/run_test integration/tests/backup_ontop.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "backup w external es"
    command:
      - integration/run_test integration/tests/backup_external_es.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "backup w external es to s3"
    command:
      - integration/run_test integration/tests/backup_external_es_s3.sh
    timeout_in_minutes: 30
    expeditor:
      accounts:
        - aws/chef-cd
      executor:
        linux:
          single-use: true
          privileged: true
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
        AWS_ACCESS_KEY_ID:
          account: aws/chef-cd
          field: access_key_id
        AWS_SECRET_ACCESS_KEY:
          account: aws/chef-cd
          field: secret_access_key
        AWS_SESSION_TOKEN:
          account: aws/chef-cd
          field: session_token
  - label: "upgrade dev -> master"
    command:
      - integration/run_test integration/tests/upgrade.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "upgrade acceptance -> master"
    command:
      - integration/run_test integration/tests/upgrade_acceptance_master.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "upgrade current -> master"
    command:
      - integration/run_test integration/tests/upgrade_current_master.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "upgrade current -> master (with latest hab)"
    command:
      - integration/run_test integration/tests/upgrade_current_master_habdev.sh
    timeout_in_minutes: 25
    soft_fail: true
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "manual upgrade current -> master"
    command:
      - integration/run_test integration/tests/manual_upgrade.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "deep upgrades"
    command:
      - integration/run_test integration/tests/deep_upgrade.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "deep migrate upgrade"
    command:
      - integration/run_test integration/tests/migrate_upgrade.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "deep upgrade backup restore"
    command:
      - integration/run_test integration/tests/deep_upgrade_backup_restore.sh
    timeout_in_minutes: 35
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "backups"
    command:
      - integration/run_test integration/tests/backup.sh
    timeout_in_minutes: 30
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        linux:
          privileged: true

  - label: "reset admin access v1"
    command:
      - integration/run_test integration/tests/reset_admin_access_v1.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "reset admin access v2"
    command:
      - integration/run_test integration/tests/reset_admin_access_v2.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "upgrade / reset IAM v2"
    command:
      - integration/run_test integration/tests/upgrade_reset_iam_v2.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "security"
    command:
      - integration/run_test integration/tests/security.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "ha data services"
    command:
      - integration/run_test integration/tests/ha_data_services.sh
    timeout_in_minutes: 35
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "ha data services migrate"
    command:
      - integration/run_test integration/tests/ha_data_services_migrate.sh
    timeout_in_minutes: 35
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "shellcheck hooks"
    command:
      - integration/run_test integration/tests/shellcheck_rendered_hooks.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "ha cluster"
    command:
      - integration/run_test integration/tests/cluster.sh
    timeout_in_minutes: 35
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "builder smoke tests"
    command:
      - integration/run_test integration/tests/bldr_smoke.sh
    timeout_in_minutes: 25
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        linux:
          privileged: true

  - label: "proxy"
    command:
      - integration/run_test integration/tests/proxy.sh
    timeout_in_minutes: 20
    expeditor:
      secrets:
        A2_LICENSE:
          path: secret/a2/license
          field: license
      executor:
        linux:
          privileged: true
