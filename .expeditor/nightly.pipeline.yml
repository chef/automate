expeditor:
  defaults:
    executor:
      docker:
        image_sha256: db2f838b6ee3a48542254407a492b7704966ea579d8a3b1fe9c946e12cd8a7d6
        workdir: /go/src/github.com/chef/automate

steps:
  - label: build
    command:
      - scripts/verify_build.sh
    timeout_in_minutes: 45
    env:
      BUILD_ALL: true
      ALLOW_LOCAL_PACKAGES: true
      HAB_STUDIO_SUP: false
      HAB_NONINTERACTIVE: true
    expeditor:
      secrets:
        HAB_STUDIO_SECRET_GITHUB_TOKEN:
          account: github/chef-ci
          field: token
      executor:
        linux:
          privileged: true

  - wait

  - label: "[integration] chef server upgrade"
    command:
      - integration/run_test integration/tests/chef_server_upgrade.sh
    timeout_in_minutes: 30 # longer timeout for chef-server
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[integration] chef server backup"
    command:
      - integration/run_test integration/tests/chef_server_backup.sh
    timeout_in_minutes: 30 # longer timeout for chef-server
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[integration] backups-no-sha256"
    command:
      - integration/run_test integration/tests/backup-no-sha.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true

  - label: "[integration] deprecated backup w external es"
    command: integration/run_test integration/tests/deprecated_backup_external_es.sh
    timeout_in_minutes: 25
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[integration] backups repo permissions"
    command:
      - integration/run_test integration/tests/backup_repo_permissions.sh
    timeout_in_minutes: 30 # it restores twice so we'll give it a while
    expeditor:
      executor:
        linux:
          single-use: true
          privileged: true

  - label: "[integration] product mitm"
    command:
      - integration/run_test integration/tests/product_mitm.sh
    timeout_in_minutes: 20
    expeditor:
      executor:
        linux:
          privileged: true
