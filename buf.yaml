################################################################################
# Protocol Buffers Linter Configuration
################################################################################
#
# ## References:
# - This configures the `buf` tool, you run the linter as `buf check lint`
# - Style Guide: https://buf.build/docs/style-guide/
# - Docs for individual checkers: https://buf.build/docs/lint-checkers
# - Config docs: https://buf.build/docs/lint-configuration
#
# ## Rationale
#
# We've adopted linting for protobufs for the same reason we have it for other
# kinds of code: avoid dangerous legal constructions, encourage consistent
# style, etc.
#
# This linter was adopted only after Automate was a mature product with
# compatibility constraints. This project uses protocol buffers to generate the
# external REST API along with gRPC client and server code. Thus, some portions
# of the protocol buffer codebase are constrained to remain compatible:
# - At the protobuf message level
# - At the JSON representation level
# - At the JSON generation/consumption level (e.g., golang struct tags)
# - At the generated code level
# To maintain compatibility at all of these layers, we must keep some of the
# protobuf code in violation of the style guide. This applies broadly to all of
# the pre-existing code in api/external, some API code in
# components/automate-gateway, the configuration protobufs, and a handful of
# special cases. Unless noted otherwise, the style guide exceptions configured
# here are intended only to cover older code. Follow the style guide whenever
# you can do so without breaking things.

build:
  roots:
    - api
    - components
    - lib
    - vendor/github.com/googleapis/googleapis
    - vendor/github.com/grpc-ecosystem/grpc-gateway
    - vendor/github.com/envoyproxy/protoc-gen-validate
  excludes:
    - components/notifications-service/
    - components/automate-grpc/protoc-gen-policy/testdata
    - vendor/github.com/googleapis/googleapis/google/api/expr
    - vendor/github.com/googleapis/googleapis/google/api/servicecontrol
    - vendor/github.com/googleapis/googleapis/google/api/servicemanagement
    - vendor/github.com/envoyproxy/protoc-gen-validate/license
    - vendor/github.com/grpc-ecosystem/grpc-gateway/third_party
    - vendor/github.com/grpc-ecosystem/grpc-gateway/runtime/internal/examplepb
lint:
  allow_comment_ignores: true
  use:
    - DEFAULT
  except:
    # This linter requires your proto package names to end with .v1 or similar. 
    # Adopting this for existing code would break anyone using our protos
    - PACKAGE_VERSION_SUFFIX 
    # buf wants you to use a file hierarchy that matches your proto package
    # names, but this is difficult and probably breaking to adopt now
    - PACKAGE_SAME_DIRECTORY 
    - PACKAGE_DIRECTORY_MATCH
    # The linters below this comment should be turned on for new things (todo)
    - RPC_RESPONSE_STANDARD_NAME
    - RPC_REQUEST_RESPONSE_UNIQUE
    - ENUM_VALUE_PREFIX
    - ENUM_ZERO_VALUE_SUFFIX
  ignore_only:
    SERVICE_SUFFIX:
      # The automate-cli accesses the `Deployment` service directly; making
      # changes to it makes the CLI unable to install older versions of
      # Automate, which is breaking.
      - interservice/deployment/automate_deployment.proto
      # /api/
      - external/cds/cds.proto
      - external/cfgmgmt/cfgmgmt.proto
      - external/data_lifecycle/data_lifecycle.proto
      - external/infra_proxy/infra_proxy.proto
      - external/ingest/chef.proto
      - external/ingest/job_scheduler.proto
      # /components/
      - automate-gateway/api/deployment/deployment.proto
      - automate-gateway/api/event_feed/event_feed.proto
      - automate-gateway/api/gateway/gateway.proto
      - automate-gateway/api/iam/v2/introspect.proto
      - automate-gateway/api/iam/v2/policy.proto
      - automate-gateway/api/iam/v2/rules.proto
      - automate-gateway/api/iam/v2/teams.proto
      - automate-gateway/api/iam/v2/tokens.proto
      - automate-gateway/api/iam/v2/users.proto
      - automate-gateway/api/legacy/legacy.proto
      - automate-gateway/api/license/license.proto
      - automate-gateway/api/notifications/notifications.proto
      - automate-gateway/api/telemetry/telemetry.proto
      # /lib/
      - grpc/debug/debug_api/debug.proto
    RPC_REQUEST_STANDARD_NAME:
      # todo:
      - interservice
      # /api/
      - external/applications/applications.proto
      - external/cds/cds.proto
      - external/cfgmgmt/cfgmgmt.proto
      - external/compliance/profiles/profiles.proto
      - external/compliance/reporting/reporting.proto
      - external/compliance/reporting/stats/stats.proto
      - external/compliance/scanner/jobs/jobs.proto
      - external/data_feed/data_feed.proto
      - external/infra_proxy/infra_proxy.proto
      - external/ingest/chef.proto
      - external/ingest/job_scheduler.proto
      - external/nodes/manager/manager.proto
      - external/nodes/nodes.proto
      - external/secrets/secrets.proto
      # /components/
      - automate-gateway/api/deployment/deployment.proto
      - automate-gateway/api/event_feed/event_feed.proto
      - automate-gateway/api/gateway/gateway.proto
      - automate-gateway/api/iam/v2/introspect.proto
      - automate-gateway/api/iam/v2/policy.proto
      - automate-gateway/api/iam/v2/rules.proto
      - automate-gateway/api/iam/v2/teams.proto
      - automate-gateway/api/iam/v2/tokens.proto
      - automate-gateway/api/iam/v2/users.proto
      - automate-gateway/api/legacy/legacy.proto
      - automate-gateway/api/license/license.proto
      - automate-gateway/api/notifications/notifications.proto
      - automate-gateway/api/telemetry/telemetry.proto
      # /lib/
      - grpc/debug/debug_api/debug.proto
    PACKAGE_SAME_GO_PACKAGE:
      # /api/
      - config
      - interservice/authz
      - interservice/authn
      - interservice/cereal
      - interservice/deployment
      - interservice/es_sidecar
      - interservice/ingest
      - interservice/license_control
      - interservice/local_user
      - interservice/pg_sidecar
      - interservice/teams
      # /components/
      - automate-gateway/api/iam/v2
      - automate-gateway/api/gateway
      - automate-grpc/protoc-gen-a2-config/api/a2conf
    FIELD_LOWER_SNAKE_CASE:
      - external/infra_proxy/response/policyfiles.proto
      # /component/
      - automate-gateway/api/notifications/notifications.proto
      - automate-deployment/pkg/persistence/boltdb/internal/v1/schema/v1.proto
    ENUM_VALUE_UPPER_SNAKE_CASE:
      - automate-gateway/api/notifications/notifications.proto
    MESSAGE_PASCAL_CASE:
      - config/dex/config_request.proto
    PACKAGE_DEFINED:
      - automate-deployment/pkg/persistence/boltdb/internal/v1/schema/v1.proto
  ignore:
    - protoc-gen-swagger # grpc gateway
    - internal # grpc gateway
    - grafeas # googleapis
    - google # googleapis
    - validate # envoyproxy/protoc-gen-validate
    - gogoproto # envoyproxy/protoc-gen-validate
    - external/habitat/event.proto # this file is owned by habitat and copied here
breaking:
  use:
    - WIRE_JSON
