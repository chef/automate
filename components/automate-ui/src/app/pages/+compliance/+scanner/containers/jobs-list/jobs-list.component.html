<chef-table class="jobs-list-table" (sort-toggled)="onSortToggled($event)">
  <chef-table-header>
    <chef-table-row>
      <chef-table-header-cell>
        Job
        <chef-sort-toggle sort="name" [order]="orderFor('name')"></chef-sort-toggle>
      </chef-table-header-cell>
      <chef-table-header-cell>
        Nodes
      </chef-table-header-cell>
      <chef-table-header-cell>
        Last Scan
        <chef-sort-toggle sort="end_time" [order]="orderFor('end_time')"></chef-sort-toggle>
      </chef-table-header-cell>
      <chef-table-header-cell>
        Status
        <chef-sort-toggle sort="status" [order]="orderFor('status')"></chef-sort-toggle>
      </chef-table-header-cell>
      <chef-table-header-cell></chef-table-header-cell>
    </chef-table-row>
  </chef-table-header>

  <chef-loading-spinner *ngIf="jobsList.loading" size="100"></chef-loading-spinner>

  <chef-table-body *ngIf="!jobsList.loading">
    <app-authorized [allOf]="['/compliance/scanner/jobs', 'post']">
      <chef-table-row class="empty new-row">
        <span class="cta">Create a new scan job with nodes and profiles</span>
        <span class="action">
          <chef-button primary [routerLink]="['/jobs/add']">Create Scan Job</chef-button>
        </span>
      </chef-table-row>
    </app-authorized>
    <chef-table-row *ngFor="let job of jobsList.items; trackBy: trackBy;">
      <chef-table-cell *ngIf="isJobReport(job)">
        {{ job.name }}
      </chef-table-cell>
      <chef-table-cell *ngIf="!isJobReport(job)">
        <a [routerLink]="['/compliance', 'scan-jobs', 'jobs', job.id, 'scans']">{{ job.name }}</a>
      </chef-table-cell>
      <chef-table-cell>{{ displayNodeCount(job.node_count | number, job.recurrence) }}</chef-table-cell>
      <chef-table-cell>{{ timeFromNow(job.end_time) }}</chef-table-cell>
      <chef-table-cell>{{ job.status }}</chef-table-cell>
      <chef-table-cell>
        <chef-button secondary
          *ngIf="job.status === 'completed' && job.recurrence === ''"
          (click)="viewReport(job.id, job.end_time)">
          Report
        </chef-button>
        <chef-button secondary caution
          *ngIf="job.status === 'failed'"
          (click)="onJobResultsShow($event, job.id)">
          Error
        </chef-button>
        <chef-button label="edit" secondary
          *ngIf="!isJobReport(job)"
          [routerLink]="['/jobs', job.id, 'edit']">
          <chef-icon>edit</chef-icon>
        </chef-button>
        <chef-button label="delete" secondary caution (click)="promptDeleteJob(job)">
          <chef-icon>delete</chef-icon>
        </chef-button>
      </chef-table-cell>
    </chef-table-row>
  </chef-table-body>
</chef-table>

<app-page-picker
  class="jobs-list-paging"
  [total]="jobsList.total"
  [perPage]="jobsList.per_page"
  [page]="jobsList.page"
  (pageChanged)="onPageChanged($event)">
</app-page-picker>

<chef-scroll-top></chef-scroll-top>

<chef-side-panel class="side-panel" [visible]="showJobResults">
  <div class="side-panel-header">
    <chef-icon class="header-icon">equalizer</chef-icon>
    <div class="header-text">
      <h4><strong>{{ (jobDetail$ | async)?.results?.length }} errors for job:</strong></h4>
      <p>{{ (jobDetail$ | async)?.name }}</p>
    </div>
    <chef-button secondary (click)="onJobResultsHide($event)">
      <chef-icon>close</chef-icon>
    </chef-button>
  </div>
  <div class="side-panel-body">
    <div class="side-panel-body-header">
      <p>Tap on a node to view the full backtrace for the error.</p>
    </div>
    <ul class="results-list">
      <li
        *ngFor="let result of (jobDetail$ | async)?.results"
        class="results-list-item">
        <div class="list-item-summary">
          <chef-icon class="list-item-icon" [ngClass]="result.status">{{ statusIcon(result.status) }}</chef-icon>
          <div class="list-item-text">
            <p class="node-name">
              <strong>Node:</strong> {{ result.node_id }}
            </p>
          </div>
          <chef-button secondary (click)="toggleResult(result)">
            <chef-icon>add</chef-icon>
          </chef-button>
        </div>
        <div class="list-item-detail" [ngClass]="result.status" *ngIf="isOpenResult(result)">
          <pre>{{ result.result }}</pre>
        </div>
      </li>
    </ul>
  </div>
</chef-side-panel>

<chef-modal
  *ngIf="jobDeletePrompt$ | async as prompt"
  id="delete-prompt"
  [visible]="prompt.visible"
  (closeModal)="cancelDeleteJob(prompt.job)">
  <h2 id="delete-prompt-title" slot="title">Are you sure you want to delete this job?</h2>
  <div>
    <p>{{ prompt.job?.name }}</p>
    <div class="options">
      <chef-button label="confirm" primary caution (click)="confirmDeleteJob(prompt.job)">Delete it</chef-button>
      <chef-button label="cancel" tertiary (click)="cancelDeleteJob(prompt.job)">Cancel</chef-button>
    </div>
  </div>
</chef-modal>
