+++
title = "IAM v2 API Reference"
description = "API reference guide for IAM v2"
draft = false
bref = ""
toc = true
[menu]
  [menu.docs]
    parent = "beta"
    weight = 30
+++

This API reference details Chef Automate IAM v2 features from the command line.
If you are not already on IAM v2, see the [IAM v2 User's Guide]({{< relref "iam-v2-guide.md#upgrade-to-iam-v2" >}}) to upgrade.
Any command with a browser equivalent includes brief directions for locating it on the corresponding page.
See the [IAM v2 Overview]({{< relref "iam-v2-overview.md" >}}) for an overview and exposition of new concepts.
See the [IAM v2 User's Guide]({{< relref "iam-v2-guide.md" >}}) for more information on setting up and using IAM v2 features.

<!--The TOC below is auto-generated by the VSCode "Markdown TOC" plugin; do not edit manually.
With the plugin installed, this TOC will update automatically when you save the file! -->
<!-- TOC depthFrom:2 depthTo:2 -->

- [General Notes](#general-notes)
- [Notes on the Projects Property](#notes-on-the-projects-property)
- [Policies](#policies)
- [Policy Membership](#policy-membership)
- [Roles](#roles)
- [Projects](#projects)
- [Project Rules](#project-rules)
- [Users](#users)
- [Teams](#teams)
- [Team Membership](#team-membership)
- [Tokens](#tokens)
- [Restoring Admin Access](#restoring-admin-access)

<!-- /TOC -->

## General Notes

1. If you do not have one already, generate an admin token for IAM v2.
   Run this command, filling in a token name of your choice:

   ```bash
   export TOKEN=`chef-automate iam token create <your-token-name-here> --admin`
   ```

2. URIs are relative to `https://<your-domain-here>/apis/iam/v2beta`, unless otherwise noted.

3. Attach the `?pretty` query string to an endpoint to get pretty-printed output.

Putting it all together with the `/policies` endpoint as an example, this command fetches the list of policies with multi-line, formatted output:

```bash
curl -sH "api-token: $TOKEN" \
  https://{{< example_fqdn "automate" >}}/apis/iam/v2beta/policies?pretty
```

For those API methods that take JSON data (typically `create` and `update` methods)
you can provide that data to the REST endpoint in a variety of ways.
If it is a relatively small size payload, you can include it in a `curl` command inline, e.g.

```bash
curl -sH "api-token: $TOKEN" -d '<your JSON here>' ...
```

If the payload is larger, it is often convenient to store it in a file, then pass that file, e.g.,

```bash
curl -sH "api-token: $TOKEN" -d @policy.json ...
```

## Notes on the Projects Property

Teams, tokens, roles, and policies all contain a top-level `projects` property; you will see that in the example JSON for each resource in the following sections.
This property associates the particular IAM resource with one or more projects.
Users must have permissions for those projects to be able to view or modify those resources.
If the `projects` property is left empty, that resource is categorized as *unassigned*.

To create those permissions for users, there is a separate and distinct `projects` property on each policy statement.
This `projects` property may **not** be empty; you must either specify specific projects or use a wildcard (`*`) to indicate all projects.

Type               | May be empty ?    | Allows "*" ?         | May specify (unassigned) ?
-------------------|-------------------|----------------------|---------------------------
top-level projects | empty allowed     | wildcard not allowed | (unassigned) not allowed
statement projects | empty not allowed | wildcard allowed     | (unassigned) allowed

## Policies

HTTP request              | Description
--------------------------|------------
GET /policies             | lists both *Chef-managed* and *Custom* policies
GET /policies/***id***    | gets the specified policy
POST /policies            | creates a *Custom* policy
PUT /policies/***id***    | updates a *Custom* policy
DELETE /policies/***id*** | deletes a *Custom* policy

### Example Policy

This policy shows two statements, each enforcing a different set of permissions.
The first policy statement grants "list" and "get" access to view users.
The second statement grants access to all the actions comprising the `editor` role.
Note that you may specify actions either inline with **actions** or using a **role** reference.
The set of actions for a statement is the union of the actions within the role and the inline actions.

```json
{
  "name": "Alpha Beta Policy",
  "id": "alpha-beta-policy-1",
  "members": ["team:local:alpha","team:ldap:beta"],
  "statements": [
    {
      "effect": "ALLOW",
      "actions": [
        "iam:users:list",
        "iam:users:get"
      ],
      "projects": [
        "*"
      ],
    },
    {
      "effect": "ALLOW",
      "role": "editor"
    }
  ],
  "projects": [
    "admin-group-1",
    "it-support",
  ]
}
```

### Listing Policies

The output includes both *Chef-managed* and *Custom* policies.
Policies migrated from IAM v1 are included as *Custom* policies.
Policy names that begin with `[Legacy]` are default policies migrated from v1.
We recommend deleting these legacy policies and setting up new IAM v2 policies in their place--be sure to copy the associated members to the new Chef-managed policies first!

*In the browser:* **Settings**  >> **Policies**

### Getting a Policy

This shows the details of a single policy, selected by its ID.

*In the browser:* **Settings**  >> **Policies** >> [select a policy]

### Creating a Policy

Create a policy by composing JSON with all the necessary policy properties (see [Policies]({{< relref "iam-v2-api-reference.md#policies" >}})).

### Updating a Policy

- You should supply all of a policy's properties, not just the ones you wish to update.
  Because the update operation modifies *all* the properties--not just the ones you specify--*properties that you do not include are reset to empty values*.
- You can modify the *membership* of both Chef-managed and custom policies; see [Policy Membership]({{< relref "iam-v2-api-reference.md#policy-membership" >}}) for more information.
- You can modify the *definition* of custom policies but not Chef-managed policies.
- The policy ID is immutable; it can only be set at creation time.

### Deleting a Policy

Deleting a policy is permanent and cannot be undone.

*In the browser:* **Settings**  >> **Policies** >> [open control menu for target policy] >> Delete

## Policy Membership

Chef Automate supports two methods for updating policy membership.

Using `PUT` lets you set membership for the entire policy; see [Setting Policy Membership]({{< relref "iam-v2-api-reference.md#setting-policy-membership" >}}).

Using `POST` lets you add members to (or remove members from) an existing membership list.
For more information, see [Adding Members to Policies]({{< relref "iam-v2-api-reference.md#adding-members-to-policies" >}}) and [Removing Members from Policies]({{< relref "iam-v2-api-reference.md#removing-members-from-policies" >}}).

HTTP request                           | Description
---------------------------------------|------------
GET /policies/***id***/members         | lists the membership
PUT /policies/***id***/members         | replaces the membership
POST /policies/***id***/members:add    | add to the membership
POST /policies/***id***/members:remove | remove from the membership

### Example Payload

```json
{
  "members": [
    "team:local:admins",
    "token:admin-token"
  ]
}
```

### Listing Policy Members

The output lists all defined members of the specified policy.

### Updating All Members on a Policy

Specifying a complete list of members is often simpler than keeping track of a policy's membership and adding or deleting specific members (whether users, team, or tokens).
Use this HTTP request to replace the policy's membership.

### Adding Members to a Policy

Specify new members to add to a policy's membership via this HTTP request.

*In the browser:* **Settings**  >> **Policies** >> [select a policy] >> **Members** >> **Add Members**

Select any local users or teams listed to add to the policy, or use **Add Member Expressions** for tokens, or LDAP or SAML users or teams.

### Removing Members from a Policy

Specify members to remove from a policy's membership via this HTTP request.
The removed members still exists within Chef Automate, but are no longer associated with this policy.

*In the browser:* **Settings**  >> **Policies** >> [select a policy] >> **Members** >> [open control menu for target member] >> Remove Member

## Roles

A role encapsulates a list of actions.
IAM v2 provides several default *Chef-managed* roles, which are essential to the operation of Chef Automate and cannot be altered.
Roles you create are *Custom* roles.

HTTP request              | Description
--------------------------|------------
GET /roles                | lists both *Chef-managed* and *Custom* roles
GET /roles/***id***       | gets the specified role
POST /roles               | creates a *Custom* role
PUT /roles/***id***       | updates a *Custom* role
DELETE /roles/***id***    | deletes a *Custom* role

### Default Chef-managed Roles

Chef-managed Role Name | ID| Actions
-----------------------|-----|--------
Owner              | owner         | \*
Viewer             | viewer        | secrets:\*:get, secrets:\*:list, infra:\*:get, infra:\*:list, compliance:\*:get, compliance:\*:list, system:\*:get, system:\*:list, event:\*:get, event:\*:list, ingest:\*:get, ingest:\*:list, iam:projects:list, iam:projects:get, applications:\*:list, applications:\*:get
Editor             | editor        | infra:\*, compliance:\*, system:\*, event:\*, ingest:\*, secrets:\*, telemetry:\*, iam:projects:list, iam:projects:get, iam:projects:assign, applications:\*
Project Owner      | project-owner | infra:\*, compliance:\*, system:\*, event:\*, ingest:\*, secrets:\*, telemetry:\*, iam:projects:list, iam:projects:get, iam:projects:assign, iam:policies:list, iam:policies:get, iam:policyMembers:\*, iam:teams:list, iam:teams:get, iam:teamUsers:\*, iam:users:get, iam:users:list
Ingest             | ingest        | infra:ingest:\*, compliance:profiles:get, compliance:profiles:list

### Example Role

```json
{
  "name": "Advocate",
  "id": "advocate-role",
  "actions": [
    "infra:*",
    "compliance:*",
    "teams:*",
    "users:*"
  ],
  "projects": [
    "east-region",
    "west-region"
  ]
}
```

### Listing Roles

The output includes both *Chef-managed* and *Custom* roles.

*In the browser:* **Settings**  >> **Roles**

### Getting a Role

This shows the details of a single role, selected by its ID.

*In the browser:* **Settings**  >> **Roles** >> [select a role]

### Creating a Role

Create a role by composing JSON with all the necessary role properties (see [Roles]({{< relref "iam-v2-api-reference.md#roles" >}})).

### Updating a Role

- You should supply all of a role's properties, not just the ones you wish to update.
  Because the update operation modifies *all* the properties--not just the ones you specify--*properties that you do not include are reset to empty values*.
- The role ID is immutable; it can only be set at creation time.

### Deleting a Role

Deleting a role is permanent and cannot be undone.

*In the browser:* **Settings**  >> **Roles** >> [open control menu for target role] >> Delete

## Projects

HTTP request              | Description
--------------------------|------------
GET /projects             | lists all projects
GET /projects/***id***    | gets the specified role
POST /projects            | creates a project
PUT /projects/***id***    | updates a project
DELETE /projects/***id*** | deletes a project

### Example Project

```json
{
  "name": "eastern region",
  "id": "eastern-region",
  "status": "NO_RULES",
  "type": "CUSTOM"
}
```

### Listing Projects

The output lists all defined projects.

*In the browser:* **Settings**  >> **Projects**

### Getting a Project

This shows the details of a single project, selected by its ID.

*In the browser:* **Settings**  >> **Projects** >> [select a project]

### Creating a Project

Create a project by composing JSON with all the necessary project properties (see [Projects]({{< relref "iam-v2-api-reference.md#projects" >}})).

### Updating a Project

- The project name is the only property of a project you can modify.
- The ID is immutable; it can only be set at creation time.

### Deleting a Project

Deleting a project is permanent and cannot be undone.

*In the browser:* **Settings**  >> **Projects** >> [open control menu for target project] >> Delete Project

## Project Rules

HTTP request                                          | Description
------------------------------------------------------|------------
GET /projects/***project_id***/rules                  | lists rules for a project
GET /projects/***project_id***/rules/***rule_id***    | gets a project rule
POST /projects/***project_id***/rules                 | creates a project rule
PUT /projects/***project_id***/rules/***rule_id***    | updates a project rule
DELETE /projects/***project_id***/rules/***rule_id*** | deletes a project rule

A rule specifies a non-empty array of conditions.
Each rule **condition** specifies values to match for a particular **attribute**.
The choice of attributes depends on the rule **type**.

Rule Type  | Available Attributes
-----------|---------------------
EVENT      | CHEF_ORGANIZATION, CHEF_SERVER
NODE       | CHEF_ORGANIZATION, CHEF_SERVER, ENVIRONMENT, CHEF_ROLE, CHEF_TAG, CHEF_POLICY_NAME, CHEF_POLICY_GROUP

Each rule condition also specifies an **operator**, either `MEMBER_OF` or `EQUALS`.
To match a single value, use `EQUALS` and include just a single value in the **values** array.
To match any one of a set of values, use `MEMBER_OF` and include the choices in the **values** array.

All rule conditions must be true for a rule to apply.
If, for example, you want to match when `chef_org` is either `project1` or `project2`, this will **not** work:

```json
{
  "operator": "EQUALS", "attribute": "CHEF_SERVER", "values": [ "project1" ],
  "operator": "EQUALS", "attribute": "CHEF_SERVER", "values": [ "project2" ]
},
```

The conjunction of those conditions will always be false because both can never be true at the same time.
Rather, write the rule with a single condition like this:

```json
{
  "operator": "MEMBER_OF",
  "attribute": "CHEF_SERVER",
  "values": [ "project1", "project2" ]
},
```

### Example Rule

```json
{
  "id": "org1-filter",
  "name": "server and org filter",
  "type": "NODE",
  "project_id": "eastern-region",
  "conditions": [
    {
      "operator": "MEMBER_OF",
      "attribute": "CHEF_SERVER",
      "values": [
        "prod",
        "staging"
      ]
    },
    {
      "operator": "EQUALS",
      "attribute": "CHEF_ORGANIZATION",
      "values": [
        "org1"
      ]
    }
  ]
}
```

### Listing Rules for a Project

The output lists all rules for a specified project.

*In the browser:* **Settings**  >> **Projects** >> [select a project]

### Getting a Project Rule

This shows the details of a single project, selected by its ID.

*In the browser:* **Settings**  >> **Projects** >> [select a project] >> [select a rule]

### Creating a Project Rule

Create a rule by composing JSON with all the necessary rule properties (see [Project Rules]({{< relref "iam-v2-api-reference.md#project-rules" >}})).

### Updating a Project Rule

- You should supply all of a rule's properties, not just the ones you wish to update.
  Because the update operation modifies *all* the properties--not just the ones you specify--*properties that you do not include are reset to empty values*.
- The rule ID is immutable; it can only be set at creation time.

### Deleting a Project Rule

Deleting a rule is permanent and cannot be undone.

*In the browser:* **Settings**  >> **Projects** >> [select a project] >> [open control menu for target rule] >> Delete Rule

## Users

HTTP request              | Description
--------------------------|------------
GET /users                | lists all users
GET /users/***id***       | gets the specified user
POST /users               | creates a user
PUT /users/***id***       | updates a user
DELETE /users/***id***    | deletes a user
GET /users/***id***/teams | list teams for a user
PUT /self/***id***        | updates your own user

### Example User

```json
{
  "name": "Douglas Adams",
  "id": "doug42",
  "password": "secret_pwd"
}
```

### Listing Users

The output lists all local users.

*In the browser:* **Settings**  >> **Users**

### Getting a User

This shows the details of a single user, selected by its ID.

*In the browser:* **Settings**  >> **Users** >> [select a user]

### Creating a User

Create a user by composing JSON with all the necessary user properties (see [Users]({{< relref "iam-v2-api-reference.md#users" >}})).

*In the browser:* **Settings**  >> **Users** >> Create User

### Updating a User

- You should supply all of a user's properties, not just the ones you wish to update.
  Because the update operation modifies *all* the properties--not just the ones you specify--*properties that you do not include are reset to empty values*.
- The user ID is immutable; it can only be set at creation time.

*In the browser:* **Settings**  >> **Users** >> [select a user] >> Edit

### Deleting a User

Deleting a user is permanent and cannot be undone.

*In the browser:* **Settings**  >> **Users** >> [open control menu for target user] >> Delete User

### List Teams for a User

The output lists all teams that contain the specified user.

### Updating Your Own User

You need admin permissions to update other users, but all local users have permission to update their own user details with this endpoint.
For this endpoint, the `password` property is optional, so you only need to supply it if you wish to change your password.
However, if you do supply `password` you must also supply one more property, `previous_password` as a security measure.

*In the browser:* **Profile Menu**  >> **Profile**

## Teams

HTTP request              | Description
--------------------------|------------
GET /teams               | lists all teams
GET /teams/***id***      | gets the specified team
POST /teams              | creates a team
PUT /teams/***id***      | updates a team
DELETE /teams/***id***   | deletes a team

### Example Team

```json
{
  "name": "team 1",
  "id": "team-1",
  "projects": [
    "east-region",
    "west-region"
  ]
}
```

### Listing Teams

The output lists all local teams.

*In the browser:* **Settings**  >> **Teams**

### Getting a Team

This shows the details of a single team, selected by its ID.

*In the browser:* **Settings**  >> **Teams** >> [select a team]

### Creating a Team

Create a team by composing JSON with all the necessary team properties (see [Teams]({{< relref "iam-v2-api-reference.md#teams" >}})).

*In the browser:* **Settings**  >> **Teams** >> Create Team

### Updating a Team

- You should supply all of a team's properties, not just the ones you wish to update.
  Because the update operation modifies *all* the properties--not just the ones you specify--*properties that you do not include are reset to empty values*.
- The team ID is immutable; it can only be set at creation time.

*In the browser:* **Settings**  >> **Teams** >> [select a team] >> Details

### Deleting a Team

Deleting a team is permanent and cannot be undone.

*In the browser:* **Settings**  >> **Teams** >> [open control menu for target team] >> Delete Team

## Team Membership

A local team consists exclusively of local users.
Note that the `user_ids` of the local users used here are GUIDs, generated when you create users.
A user's GUID is reported in the `membership_id` property when you fetch a user.

HTTP request                           | Description
---------------------------------------|------------
GET /teams/***id***/users              | lists the membership
POST /teams/***id***/users:add         | add to the membership
POST /teams/***id***/users:remove      | remove from the membership

### Example payload

```json
{
  "id": "team-1",
  "user_ids": [
    "1a5a63d7-0b14-465a-aec1-5eea08a72343",
    "6c4e3e8a-fade-4a9c-ac9f-99b86677530b"
  ]
}
```

### Listing Team Users

The output lists all local users on the specified team.

### Adding Users to a Team

Specify new users to add to a team's membership via this HTTP request.

*In the browser:* **Settings**  >> **Teams** >> [select a team] >> **Users** >> **Add User**

Select any local users listed to add to the team.

### Removing Users from a Team

Specify users to remove from a team's membership via this HTTP request.
The removed users still exists within Chef Automate, but are no longer associated with this team.

*In the browser:* **Settings**  >> **Teams** >> [select a team] >> **Users** >> [open control menu for target user] >> Remove User

## Tokens

HTTP request              | Description
--------------------------|------------
GET /tokens               | lists all tokens
GET /tokens/***id***      | gets the specified token
POST /tokens              | creates a token
PUT /tokens/***id***      | updates a token
DELETE /tokens/***id***   | deletes a token

### Example Token

```json
{
  "name": "token 1",
  "id": "token-1",
  "active": true,
  "projects": [
    "east-region",
    "west-region"
  ]
}
```

### Listing Tokens

This lists admin and non-admin tokens.

*In the browser:* **Settings**  >> **API Tokens**

### Getting a Token

This shows the details of a single token, selected by its ID.

*In the browser:* **Settings**  >> **API Tokens** >> [select a token]

### Creating a Token

Create a token by composing JSON with all the necessary token properties (see [Tokens]({{< relref "iam-v2-api-reference.md#tokens" >}})).
Note that this creates **non**-admin tokens that may then be assigned permissions via policies just like users or teams (unless you have already created policies that encompass all tokens using `tokens:*`).

You cannot create admin tokens via the REST API.
Admin tokens can only be created by specifying the `--admin` flag to this `chef-automate` sub-command:

```bash
  chef-automate iam token create <your-token-name> --admin
```

*In the browser:* **Settings**  >> **API Tokens** >> Create Token

### Updating a Token

- You should supply all of a token's properties, not just the ones you wish to update.
  Because the update operation modifies *all* the properties--not just the ones you specify--*properties that you do not include are reset to empty values*.
- The token ID is immutable; it can only be set at creation time.

*In the browser:* **Settings**  >> **API Tokens** >> [select a token] >> Details

### Deleting a Token

Deleting a token is permanent and cannot be undone.

*In the browser:* **Settings**  >> **API Tokens** >> [open control menu for target token] >> Delete Token

## Restoring Admin Access

While we have [safeguards]({{< relref "iam-v2-overview.md#policy-types" >}}) to prevent it, it is possible to lock yourself out of Chef Automate.
If you have root access to the node where Chef Automate is installed, use the following commands to restore admin access:

<!-- Wording/Replace password/replace token/v1 commands won't work on c2 -->

This command, which is also available on IAM v1, resets the local `admin` user's password and ensures that user is a member of the local `admins` team, which is a permanent member of the Chef-managed `Administrator` policy.

```bash
  chef-automate iam admin-access restore <your new password here>
```

Generate a new token and add that token as a new member of the Chef-managed `Administrator` policy. This is the equivalent of the v1 command `chef-automate admin-token`.

```bash
  chef-automate iam token create <your token name here> --admin
```
