# A2 Backups

## Desired State

#### Backups
This document outlines how we plan to implement backup and restore operations for Automate 2. It's describes a three phase plan that we'll use to incrementally deliver value until we realize our eventual goal of distributed backups orchestrated by the `deployment-service`.

Each service in A2 will be responsible and require a gRPC endpoint for:
  * creating a backup of its data
  * tracking and showing the status of a backup create operation
  * restore itself from a backup
  * listing its available backups
  * tracking and showing the short term status of a backup restore operation
  * tracking and showing the long term status of a backup restore operation

We do this for complete isolation between domains. Rather than create a backup monolith we'll create primitive services and libraries that domain services can utilize to fulfill their platform contract.

In this model the `deployment-service` will act as an orchestrator of a backup operation. When a backup create operation is initiated it will create a unique identifier for the backup and make requests to all services in the platform to create a backup using the same root identifier. The `deployment-service` will track the status of the backup operation across all services in the platform using the root identifier and will aggregate them into a single status response for the client that initiated the request.

#### Restores
During a restore, the user will provide a path to a backup repository with an identifier to the `chef-automate` CLI utility. The CLI will be responsible for creating a restoration identifier and using the `deployment-service` backup to bootstrap the `deployment-service`. After the `deployment-service` has been restored, the CLI will complete the restoration via gRPC requests to the `deployment-service` using the restoration identifier and backup identifier.

The `deployment-service` will bring up all infrastructure and domain services that were available when the backup was created. After the services have initialized, the `deployment-service` will request a restoration for a specific backup using the backup identifier and restore identifier to each service. It will use the two identifiers to track and aggregate the restoration status across all services and output the result to the initiating client.

Domain services will need to implement two restoration tracking rRPC API's:
  * Short term status: This indicates that the service should be considered down because it hasn't completed the restoration required for the service to run in a partially restored state.
  * Long term status: This indicates that the service is operating in a partially restored state but can continue to operate in the meantime.

  The long term restoration will be useful for services that have lots of data that may takes hours to restore: eg: elasticsearch.

#### Helper primitives

To simplify common persistence operations, some infrastructure services primitives will be made available for domain services to utilize when implementing the backup and restore gRPC endpoints for their service.

* `es-sidecar-service`
The sidecar service will implement gRPC endpoints for:
  * creating snapshot repositories
  * creating snapshots
  * restoring snapshots
  * tracking snapshots
  * restoring snapshots

* `backup-gateway`
The backup-gateway acts a proxy between services creating backup objects and the desired storage location (filesystem, s3). When in local filesystem mode the backup-gateway exposes an S3 compatible API and stores objects on the local filesystem. In s3 mode it acts a proxy to an actual S3 bucket where it intercepts and re-signs S3 requests and proxies them to the configured bucket. In both modes, all services will communicate with the backup-gateway service using a secret access key and secret key that are generated by the `secrets-helper`. In S3 mode, only the backup-gateway will utilize real S3 credentials to re-sign authenticated requests and proxy them to the configured S3 endpoint.

* `pg-sidecar-service`
The sidecar service will implement gRPC endpoints for:
  * creating db archive repos (in the `backup-gateway`)
  * creating database dump artifacts
  * uploading the artifacts to the backup-gateway
  * restoring backup artifacts from a backup-gateway into postgres
  * tracking backup status
  * tracking restore status

## Phase One - MVP (Complete)

In phase one we have a single rule: the backup archives that are created must be forward compatible with the future implementation that we're going to build. Strict adherence to domain driven design will not be required but will be encouraged.

Each service's data will be backed up into three distinct types of data:
  * DB Dumps. These we'll be a PG dump of the services PostgresSQL db's
  * ES Snapshots. Each service will have an elasticsearch backup repository.
  * File blobs. Any files on disk that that the service requires will be aggregated into a tar archive and compressed.

The deployment service will maintain specifications for each service that list each of the services postgresql dbs, elasticsearch indices, and files/directories that need to be backed up. During a backup the deployment service will iterate over each service and backup any of the requisite data to a given location on disk. When phase three is implemented the deployment service will stop tracking and maintaining these specifications as it will be the responsibility of the service to maintain their own backup.

The backup filesystem location must be configurable and should be laid out to support complete isolation between domain services. Here we'll try to emulate a pattern that the backup-gateway will eventually use to store the data.

```
/var/opt/automate/backups/201803028122343/
  -> deployment-service/metadata.json
  -> deployment-service/bolt/bolt.db
  -> compliance-service/metadata.json
  -> compliance-service/pg_data/chef_compliance_service.sql
/var/opt/automate/backups/automate-elasticsearch-data/
  -> chef-automate-es6-compliance-service/indices/...
  -> chef-automate-es5-ingest-service/indices/...
```

Each backup archive should have any metadata required to restore the data.

`chef-automate backup create` will creates a backup of each service in A2. It makes a gRPC request to the deployment service which then iterates over all of the services specifications and creates the backup artifacts and snapshots for each service into the backup repository.
`chef-automate backup list` lists the backups in the backup repository.
`chef-automate restore list /var/opt/automate/backups` takes a positional argument for a backup repo path and lists the available backups.
`chef-automate restore /var/opt/automate/backups <UUID>` accepts two positional arguments. The path to the backup repo and the backup identifier. It then restores the backup.

## Phase Two - Sidecar Services (In progress)

In phase two we'll work to decouple most of the backup heavy lifting from the deployment-service into infrastructure sidecar services.

* `es-sidecar-service` should implement
  repo: create, delete
  snapshot: create, delete, restore, status

* `pg-sidecar-service` should implement
  repo: create, delete
  backup: create, delete, restore, status

* `backup-gateway` should implement
  S3 compatible API for local filesystem storage and S3 proxy

The `pg-sidecar-service` should use the `backup-gateway` for database archives.
The `es-sidecar-service` should use the `backup-gateway` for elasticsearch snapshots.

Existing backups from phase one must be compatible to the new `backup-gateway` in filesystem mode.

The `deployment-service` must delegate to the sidecar services when creating, updating, restoring, and deleting backups.

## Phase Three - Service Endpoints

In phase three the backup and restore gRPC endpoints for all services need to be implemented.

Each service must support:
  backup: create, list, restore, status
  restore: create, list, restore, status

The services should be configured to utilize the same infrastructure services that the `deployment-service` started to utilize in phase two.

The deployment service should delegate all backup and restore operations to the services.
